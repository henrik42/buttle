<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>buttle.proxy documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Buttle</span> <span class="project-version">0.1.4</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Buttle README</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buttle</span></div></div></li><li class="depth-2 branch"><a href="buttle.connection-pool-data-source.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>connection-pool-data-source</span></div></a></li><li class="depth-2 branch"><a href="buttle.data-source.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>data-source</span></div></a></li><li class="depth-2 branch"><a href="buttle.driver.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>driver</span></div></a></li><li class="depth-2 branch"><a href="buttle.driver-manager.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>driver-manager</span></div></a></li><li class="depth-2 branch"><a href="buttle.event.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>event</span></div></a></li><li class="depth-2 branch current"><a href="buttle.proxy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proxy</span></div></a></li><li class="depth-2 branch"><a href="buttle.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="buttle.xa-data-source.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>xa-data-source</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="buttle.proxy.html#var--.3Einvoke-event"><div class="inner"><span>-&gt;invoke-event</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var--.3Ereturn-event"><div class="inner"><span>-&gt;return-event</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var--.3Ethrow-event"><div class="inner"><span>-&gt;throw-event</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-def-handle"><div class="inner"><span>def-handle</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-fix-prefers.21"><div class="inner"><span>fix-prefers!</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-function-default-hierarchy"><div class="inner"><span>function-default-hierarchy</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-handle"><div class="inner"><span>handle</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-handle-default"><div class="inner"><span>handle-default</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-invocation-key"><div class="inner"><span>invocation-key</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-invoke-fn"><div class="inner"><span>invoke-fn</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-make-proxy"><div class="inner"><span>make-proxy</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-methods-of"><div class="inner"><span>methods-of</span></div></a></li><li class="depth-1"><a href="buttle.proxy.html#var-remove-handle"><div class="inner"><span>remove-handle</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">buttle.proxy</h1><div class="doc"><div class="markdown"><p>A proxy factory.</p>
<p>This namespace delivers all functions needed to (generically) create proxies for JDBC related interfaces and to implement the delegation logic for these proxies that is needed to route method calls through to the <em>real</em> JDBC driver’s instances.</p>
<p>In order to hook your own code into the delegation use <code>def-handle</code> to register your functions for certain method calls.</p></div></div><div class="public anchor" id="var--.3Einvoke-event"><h3>-&gt;invoke-event</h3><div class="usage"><code>(-&gt;invoke-event the-method target-obj the-args)</code></div><div class="doc"><div class="markdown"><p>Returns an <em>invoke-event-map</em>.</p></div></div></div><div class="public anchor" id="var--.3Ereturn-event"><h3>-&gt;return-event</h3><div class="usage"><code>(-&gt;return-event invoke-evt r)</code></div><div class="doc"><div class="markdown"><p>Returns a <em>return-event-map</em>.</p></div></div></div><div class="public anchor" id="var--.3Ethrow-event"><h3>-&gt;throw-event</h3><div class="usage"><code>(-&gt;throw-event invoke-evt t)</code></div><div class="doc"><div class="markdown"><p>Returns a <em>throw-event-map</em>.</p></div></div></div><div class="public anchor" id="var-def-handle"><h3>def-handle</h3><h4 class="type">macro</h4><div class="usage"><code>(def-handle [clss mthd] [the-method target-obj the-args] body)</code></div><div class="doc"><div class="markdown"><p>Registers a <code>handle</code> method implementation for dispatch (as of <code>invocation-key</code>) value <code>[clss mthd]</code>. Can be undone via <code>remove-handle</code>. Re-registering just overwrites.</p>
<p>Uses <code>fix-prefers!</code> on the given key. So you may use keys like <strong>(a)</strong> <code>[Object :buttle/getCatalog]</code> and <strong>(b)</strong> <code>[java.sql.Connection :buttle/default]</code> to register an implementation for <strong>(a)</strong> specific method <strong>names</strong> (ignoring the defining class/interface) and <strong>(b)</strong> specific interfaces ignoring the method name (with a <strong>preference</strong> for <strong>(b)</strong> in conflicting cases).</p>
<p>The most specific registration would be <code>[java.sql.Connection
:buttle/getCatalog]</code>. So this would be prefered over <strong>(a)</strong> and <strong>(b)</strong> when present.</p>
<p><strong>Note:</strong> This macro (i.e. the resulting code) may not be not thread-safe because it uses <code>fix-prefers!</code> which may not be thread-safe. You should use <code>def-handle</code> only in top-level-forms for defining <code>handle</code> method-implemenations but not in functions you call as part of the program flow.</p></div></div></div><div class="public anchor" id="var-fix-prefers.21"><h3>fix-prefers!</h3><div class="usage"><code>(fix-prefers! [clss mthd])</code></div><div class="doc"><div class="markdown"><p>If <code>(= mthd :buttle/default)</code> makes all/any method <code>m</code> of class <code>clss</code> (via <code>derive</code>) a child of <code>:buttle/default</code> and <em>prefers</em> <code>[clss :buttle/default]</code> over <code>[java.lang.Object m]</code>. This lets you dispatch via <code>invocation-key</code> with an <em>inheritance</em> mechanism which uses/combines <code>isa?</code> on types <code>(isa? Connection Object)</code> and on method keys <code>(isa? :buttle/getCatalog :buttle/default)</code>.</p>
<p>Now you can <strong>(a)</strong> <code>def-handle [Object :buttle/getCatalog]</code> and <strong>(b)</strong> <code>def-handle [java.sql.Connection :buttle/default]</code> with a <strong>preference</strong> for <strong>(a)</strong> when calling <code>Connection/getCatalog</code>.</p>
<p>This function is thread-safe only if <code>derive</code> and <code>prefer-method</code> are so. You will usually not use this function directly but only through <code>def-handle</code>.</p></div></div></div><div class="public anchor" id="var-function-default-hierarchy"><h3>function-default-hierarchy</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Atom carrying a simple/shallow hierarchy of <code>:buttle/&lt;method-name&gt;</code> to <code>:buttle/default</code> entries. This hierarchy is used for <code>handle</code> multi-method and <code>fix-prefers!</code>.</p></div></div></div><div class="public anchor" id="var-handle"><h3>handle</h3><h4 class="type">multimethod</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>A generic delegation function (arity <code>[the-method target-obj
the-args]</code>) which delivers proxy’ed return values.</p>
<p>The <code>:default</code> implementation just delegates to <code>handle-default</code>.</p>
<p>The multi-method dispatch is done on <code>invocation-key</code>.</p>
<p>This is a multi-method so that you have a means (see <code>def-handle</code>) to hook into the execution/delegation/proxying logic for some/any of the proxy’ed interface types i.e. <code>invocation-key</code> dispatch values.</p></div></div></div><div class="public anchor" id="var-handle-default"><h3>handle-default</h3><div class="usage"><code>(handle-default the-method target-obj the-args)</code></div><div class="doc"><div class="markdown"><p>Calls <code>the-method</code> on <code>target-obj</code> with <code>the-args</code>, creates a proxy via <code>make-proxy</code> (which uses <code>handle</code> as its <code>handler-fn</code>) for non-<code>nil</code> interface-typed return values and returns the (possibly proxy’ed) result. Throws if the invoked method throws.</p>
<p>Sends (<code>buttle.event/send-event</code>) an <code>-&gt;invoke-event</code> before calling <code>the-method</code>. Sends a <code>-&gt;throw-event</code> if <code>the-method</code> call throws. Else sends a <code>-&gt;return-event</code> before result proxy is created.</p></div></div></div><div class="public anchor" id="var-invocation-key"><h3>invocation-key</h3><div class="usage"><code>(invocation-key the-method &amp; _)</code></div><div class="doc"><div class="markdown"><p>Dispatch function for <code>handle</code>. Returns a vector with the method’s declaring class and <code>buttle/</code> namespaced keyword for the method’s name.</p>
<p>Example:</p>
<pre><code>(-&gt; java.sql.Connection
    (.getMethod "close" nil)
    invocation-key)
;; --&gt; [java.sql.Connection :buttle/close]
</code></pre></div></div></div><div class="public anchor" id="var-invoke-fn"><h3>invoke-fn</h3><div class="usage"><code>(invoke-fn proxy-type target-obj handler-fn the-proxy the-method the-args)</code></div><div class="doc"><div class="markdown"><p>Invocation handler for <code>make-proxy</code>. It delegates any method invocation of <code>proxy-type</code> (which may be an interface or a vector of interfaces) to <code>handler-fn</code>. Any other method invocations (like <code>Object.toString()</code>) will be invoked on <code>target-object</code>.</p>
<p>Note that any <code>java.lang.reflect.InvocationTargetException</code> (incl. those coming from <code>handler-fn</code>) will be un-rolled so that the cause <code>Exception</code> will come out of <code>invoke-fn</code> and thus the proxy made by <code>make-proxy</code>.</p>
<p>This function is not meant for public usage. It functions as a hookable delegation-point for <code>make-proxy</code> so that you may re-bind/re-def the var when debugging and hacking.</p></div></div></div><div class="public anchor" id="var-make-proxy"><h3>make-proxy</h3><div class="usage"><code>(make-proxy proxy-type target-obj handler-fn)</code></div><div class="doc"><div class="markdown"><p>A proxy factory.</p>
<p>Creates and returns a <strong>Java dynamic proxy</strong> with <code>proxy-type</code> (which may be an interface or a vector of interfaces).</p>
<p>The proxy delegates any method invocation to <code>invoke-fn</code> which in turn delegates to <code>handler-fn</code>.</p>
<p>The classloader for this proxy is taken from the first interface. If you want to delegate invocations on this proxy D through handler-fn and onto a Clojure proxy P you have to make sure, that D’s and P’s method/class declarations are compatible. See notes on classloading in src/buttle/connection_pool_data_source.clj for more details.</p>
<p>Example usage:</p>
<pre><code> (make-proxy java.sql.Driver "foo-driver"
  (fn [the-method target-obj the-args]
    (condp = (.getName the-method)
      "acceptsURL" true
      "connect" (proxy [java.sql.Connection] []
                  (toString [] "foo-connection")))))
</code></pre></div></div></div><div class="public anchor" id="var-methods-of"><h3>methods-of</h3><div class="usage"><code>(methods-of clss)</code></div><div class="doc"><div class="markdown"><p>Returns seq of <code>:buttle/</code> namespaced method names of class <code>clss</code>.</p></div></div></div><div class="public anchor" id="var-remove-handle"><h3>remove-handle</h3><div class="usage"><code>(remove-handle [clss mthd])</code></div><div class="doc"><div class="markdown"><p>Removes the <code>handle</code> for <code>[clss mthd]</code>. No-op if there is no registered <code>handle</code> for this key.</p></div></div></div></div></body></html>