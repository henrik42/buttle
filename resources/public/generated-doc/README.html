<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Buttle README</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Buttle</span> <span class="project-version">0.1.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="README.html"><div class="inner"><span>Buttle README</span></div></a></li><li class="depth-1 "><a href="intro_de.html"><div class="inner"><span>(German) Einführung in Buttle</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buttle</span></div></div></li><li class="depth-2 branch"><a href="buttle.driver.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>driver</span></div></a></li><li class="depth-2 branch"><a href="buttle.driver-manager.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>driver-manager</span></div></a></li><li class="depth-2 branch"><a href="buttle.event.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>event</span></div></a></li><li class="depth-2 branch"><a href="buttle.proxy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proxy</span></div></a></li><li class="depth-2"><a href="buttle.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#buttle-readme" name="buttle-readme"></a>Buttle README</h1>
<h2><a href="#what-is-it-" name="what-is-it-"></a>What is it?</h2>
<p><em>Buttle</em> is a proxying JDBC driver which wraps <em>real</em> JDBC drivers.</p>
<p><em>Buttle</em> supplies a <code>java.sql.Driver</code> which delegates calls to a backing <code>Driver</code> (like <code>org.postgresql.Driver</code>). <em>Buttle</em> then constructs proxies <em>around</em> the returned values. These proxies then do the same for their proxied instances (and so on).</p>
<p>Proxies are only constructed for methods (i.e. their returned values) that have interface-typed declared return types.</p>
<p><em>Buttle</em> proxies create <em>events</em> for every method invocation and completion incl. when an <code>Exception</code> is thrown. These events include info about</p>
<ul>
  <li>timestamp of the event</li>
  <li>duration (for completion/<code>Exception</code>)</li>
  <li>stacktrace (for exceptions)</li>
  <li>invoked class/method</li>
  <li>arguments</li>
  <li>returned value/<code>Exception</code></li>
</ul>
<p>Events are communicated through a <code>core.async</code> channel so that users can consume that channel to receive the events.</p>
<h2><a href="#what-to-use-it-for-" name="what-to-use-it-for-"></a>What to use it for?</h2>
<p>Use it for</p>
<ul>
  <li>
  <p>troubleshooting</p></li>
  <li>
  <p>debugging</p></li>
  <li>
  <p>performance measurements</p></li>
  <li>
  <p>application monitoring</p></li>
</ul>
<h2><a href="#how-to-extend-" name="how-to-extend-"></a>How to extend?</h2>
<p>There are two ways to <em>hook into</em>:</p>
<p><strong>events</strong>: receive events from <em>Buttle</em> through  <code>buttle.event/event-mult</code> like this:</p>
<pre><code>(let [ch (clojure.core.async/chan)]
  (clojure.core.async/tap buttle.event/event-mult ch)
  (clojure.core.async/go
   (loop []
     (when-let [e (clojure.core.async/&lt;! ch)]
       (println e) ;; do something with the event
       (recur)))))
</code></pre>
<p><strong>multi method</strong>: <em>install</em> your own proxy for <em>target</em>  interfaces/methods. This acts like an AOP advice/proxy. Note that in  this case you have to take care to send events if you need that (see  <code>buttle.proxy/handle-default</code>).</p>
<p>You can (re-) register the <code>buttle.proxy/handle :default</code>. </p>
<pre><code>(defmethod buttle.proxy/handle :default [the-method target-obj the-args]
  (do-some-thing-with-call the-method target-obj the-args))
</code></pre>
<p>And you can register multi method implementation for just specific interfaces, methods or a combination (see <code>test/buttle/proxy_test.clj</code> for more examples):</p>
<pre><code>(buttle.proxy/def-handle [java.sql.Connection :buttle/getCatalog] [the-method target-obj the-args]
  (str "Connection/getCatalog: intercepted " (.getName the-method)))
</code></pre>
<h2><a href="#examples" name="examples"></a>Examples</h2>
<p><strong>SQuirreL</strong></p>
<p><strong>(1)</strong> Add UBERJAR to SQuirrelL’s classpath in <code>squirrel-sql.bat</code>. </p>
<pre><code>set TMP_CP="%SQUIRREL_SQL_HOME%\squirrel-sql.jar;&lt;path-to&gt;\buttle-0.1.0-SNAPSHOT-standalone.jar"
</code></pre>
<p><strong>Note:</strong> Adding the <em>Buttle</em> UBERJAR via <em>Driver</em> / <em>Extra Class Path</em>  did not work for me due to classloading handling in  Clojure. So I really had to add it to the JVMs classpath as shown  here.</p>
<p>If you want to see events in the squirrel log:</p>
<pre><code>set BUTTLE_USER_FORM="-Dbuttle.user-form=(load-file ""C:/buttle-workspace/examples/buttle/examples/event_channel.clj"")"
java %BUTTLE_USER_FORM% [...]
</code></pre>
<p><strong>(2)</strong> Add a <em>Driver</em> with class <code>buttle.jdbc.Driver</code>. </p>
<p><strong>(3)</strong> Add <em>Alias</em> with URL (replace <code>&lt;user&gt;</code> and <code>&lt;password&gt;</code>). Text  following <code>jdbc:buttle:</code> will be read as Clojure map form.</p>
<pre><code>jdbc:buttle:{:user "&lt;user&gt;" :password "&lt;password&gt;" :target-url "jdbc:postgresql://127.0.0.1:6632/postgres"}
</code></pre>
<p><strong>Clojure</strong></p>
<pre><code>C:&gt;java -cp buttle-0.1.0-SNAPSHOT-standalone.jar;postgresql-9.4.1212.jar clojure.main -r
Clojure 1.8.0
user=&gt; (use 'buttle.driver-manager)
;;--&gt; nil
(-&gt; (get-connection "jdbc:buttle:{:user \"&lt;user&gt;\" :password \"&lt;password&gt;\" :target-url \"jdbc:postgresql://127.0.0.1:6632/postgres?\"}" nil nil)
    .createStatement
    (.executeQuery "select * from pg_catalog.pg_tables where schemaname = 'pg_catalog'")
    (resultset-seq))
</code></pre>
<p><strong>Java</strong></p>
<pre><code>import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;

public class ButtleTest {

    public static void processEvent(Object e) {
       System.out.println("event : " + e);
    }

    public static void main(String[] args) throws Exception {

       System.setProperty("buttle.user-form", "(load-file \"examples/buttle/examples/java_events.clj\")");

       String user = System.getProperty("buttle_user");
       String password = System.getProperty("buttle_password");

       String jdbcUrl = "jdbc:postgresql://127.0.0.1:6632/postgres";
       String buttleUrl = String.format("jdbc:buttle:{:user \"%s\" :password \"%s\" :target-url \"%s\"}", user,
          password, jdbcUrl);

       Connection conn = DriverManager.getConnection(buttleUrl, user, password);

       Statement stmt = conn.createStatement();
       ResultSet rs = stmt.executeQuery("select * from pg_catalog.pg_tables where schemaname = 'pg_catalog'");

       for (int cc = rs.getMetaData().getColumnCount(); rs.next();) {
         for (int i = 1; i &lt;= cc; i++) {
          System.out.print(i == 1 ? "" : ",");
          System.out.print(rs.getObject(i));
         }
         System.out.println();
       }
    }
}
</code></pre>
<p>Build to <code>target/</code> dir:</p>
<pre><code>C:\&gt;javac -d target java\ButtleTest.java
</code></pre>
<p>And run (adjust paths as needed):</p>
<pre><code>C:\&gt;java -cp buttle-0.1.0-SNAPSHOT-standalone.jar;postgresql-9.4.1212.jar;target -Dbuttle_user=&lt;user&gt; -Dbuttle_password=&lt;password&gt; ButtleTest
</code></pre>
<h2><a href="#tests" name="tests"></a>Tests</h2>
<p>You’ll need a Postgres at <code>127.0.0.1:6632</code> (but see <code>jdbc-url</code> in <code>test/buttle/core_test.clj</code>).</p>
<p><strong>Windows</strong></p>
<pre><code>&gt; set buttle_user=&lt;user&gt;
&gt; set buttle_password=&lt;password&gt;
&gt; lein test
</code></pre>
<p><strong>Linux</strong></p>
<pre><code>$ buttle_user=&lt;user&gt; buttle_password=&lt;password&gt; lein test
</code></pre></div></div></div></body></html>