<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>buttle.driver documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Buttle</span> <span class="project-version">0.1.2-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Buttle README</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buttle</span></div></div></li><li class="depth-2 branch"><a href="buttle.connection-pool-data-source.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>connection-pool-data-source</span></div></a></li><li class="depth-2 branch"><a href="buttle.data-source.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>data-source</span></div></a></li><li class="depth-2 branch current"><a href="buttle.driver.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>driver</span></div></a></li><li class="depth-2 branch"><a href="buttle.driver-manager.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>driver-manager</span></div></a></li><li class="depth-2 branch"><a href="buttle.event.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>event</span></div></a></li><li class="depth-2 branch"><a href="buttle.proxy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proxy</span></div></a></li><li class="depth-2 branch"><a href="buttle.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="buttle.xa-data-source.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>xa-data-source</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="buttle.driver.html#var--acceptsURL"><div class="inner"><span>-acceptsURL</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--connect"><div class="inner"><span>-connect</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--getMajorVersion"><div class="inner"><span>-getMajorVersion</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--getMinorVersion"><div class="inner"><span>-getMinorVersion</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--getParentLogger"><div class="inner"><span>-getParentLogger</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--getPropertyInfo"><div class="inner"><span>-getPropertyInfo</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--init"><div class="inner"><span>-init</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var--jdbcCompliant"><div class="inner"><span>-jdbcCompliant</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var-accepts-url-fn"><div class="inner"><span>accepts-url-fn</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var-connect-fn"><div class="inner"><span>connect-fn</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var-eval-buttle-user-file.21"><div class="inner"><span>eval-buttle-user-file!</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var-make-driver"><div class="inner"><span>make-driver</span></div></a></li><li class="depth-1"><a href="buttle.driver.html#var-parse-jdbc-url"><div class="inner"><span>parse-jdbc-url</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">buttle.driver</h1><div class="doc"><div class="markdown"><p>The <em>Buttle</em> <code>java.sql.Driver</code>.</p>
<p>This namespace delivers <code>buttle.jdbc.Driver</code> via <code>:gen-class</code>. This named class can be used by tools (like SQuirreL) and the SPI <code>services/java.sql.Driver</code>.</p>
<p>The <code>-init</code> constructor function will register a <em>Buttle</em> <code>Driver</code> proxy (see <code>make-driver</code>) with the <code>java.sql.DriverManager</code>. So whenever an instance of <code>buttle.jdbc.Driver</code> is created, a new proxy ( <strong>not</strong> the <code>buttle.jdbc.Driver</code>!) is registered.</p>
<p><strong>Example JDBC-URL</strong>:</p>
<pre><code>jdbc:buttle:{:user "&lt;user&gt;" :password "&lt;password&gt;" :target-url "jdbc:postgresql://127.0.0.1:6632/postgres"}
</code></pre>
<p><strong>Example Wildfly datasource</strong> (see README for more details):</p>
<pre><code>  &lt;datasource jndi-name="java:/jdbc/buttle-ds" pool-name="buttle-ds" use-java-context="true"&gt;
      &lt;driver&gt;buttle-driver&lt;/driver&gt;
      &lt;connection-url&gt;
              jdbc:buttle:{
                      :user "&lt;user&gt;"
                      :password "&lt;password&gt;"
                      :class-for-name "org.postgresql.Driver"
                      :target-url "jdbc:postgresql://&lt;host&gt;:&lt;port&gt;/&lt;db-id&gt;"}
          &lt;/connection-url&gt;
  &lt;/datasource&gt;
</code></pre>
<p>When this namespace is loaded <code>eval-buttle-user-file!</code> will be executed.</p>
<p><strong>WARNING:</strong> this means that anyone who controls the system properties of the hosting JVM can run any Clojure code (but then again — when someone controls the system properties he/she is probably able to run any command anyway).</p>
<p>Functions in this namespace deliver all the functionality needed for the <code>java.sql.Driver</code> interface/contract. Things for connections, statements etc. are all delivered through <code>buttle.proxy</code>.</p></div></div><div class="public anchor" id="var--acceptsURL"><h3>-acceptsURL</h3><div class="usage"><code>(-acceptsURL this url)</code></div><div class="doc"><div class="markdown"><p>Implements <code>java.sql.Driver.acceptsURL(String)</code>. Just delegates to the referenced/internal driver (see <code>-init</code>).</p></div></div></div><div class="public anchor" id="var--connect"><h3>-connect</h3><div class="usage"><code>(-connect this url info)</code></div><div class="doc"><div class="markdown"><p>Implements <code>java.sql.Driver.connect(String, Properties)</code>. Just delegates to the referenced/internal driver (see <code>-init</code>) which calls <code>connect-fn</code>.</p></div></div></div><div class="public anchor" id="var--getMajorVersion"><h3>-getMajorVersion</h3><div class="usage"><code>(-getMajorVersion this)</code></div><div class="doc"><div class="markdown"><p>Just delegates to the referenced/internal driver (see <code>-init</code>).</p></div></div></div><div class="public anchor" id="var--getMinorVersion"><h3>-getMinorVersion</h3><div class="usage"><code>(-getMinorVersion this)</code></div><div class="doc"><div class="markdown"><p>Just delegates to the referenced/internal driver (see <code>-init</code>).</p></div></div></div><div class="public anchor" id="var--getParentLogger"><h3>-getParentLogger</h3><div class="usage"><code>(-getParentLogger this)</code></div><div class="doc"><div class="markdown"><p>Just delegates to the referenced/internal driver (see <code>-init</code>).</p></div></div></div><div class="public anchor" id="var--getPropertyInfo"><h3>-getPropertyInfo</h3><div class="usage"><code>(-getPropertyInfo this url info)</code></div><div class="doc"><div class="markdown"><p>Just delegates to the referenced/internal driver (see <code>-init</code>).</p></div></div></div><div class="public anchor" id="var--init"><h3>-init</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Constructor function of <code>buttle.jdbc.Driver</code>.</p>
<p>On first invokation creates a <em>Buttle</em> <code>Driver</code> (see <code>make-driver</code>), keeps a reference to it and registers it with the <code>java.sql.DriverManager</code>.</p>
<p>This <em>Buttle</em> driver becomes the internal <code>state</code> of the <code>buttle.jdbc.Driver</code>. All <code>Driver</code> method implemenations of this class delegate to this internal driver.</p></div></div></div><div class="public anchor" id="var--jdbcCompliant"><h3>-jdbcCompliant</h3><div class="usage"><code>(-jdbcCompliant this)</code></div><div class="doc"><div class="markdown"><p>Just delegates to the referenced/internal driver (see <code>-init</code>).</p></div></div></div><div class="public anchor" id="var-accepts-url-fn"><h3>accepts-url-fn</h3><div class="usage"><code>(accepts-url-fn url)</code></div><div class="doc"><div class="markdown"><p>Parses <code>url</code> via <code>parse-jdbc-url</code> and retrieves the keys <code>:target-url</code>, <code>:user</code>, <code>:password</code>, <code>:class-for-name</code> and <code>:datasource-spec</code> from the returned value (assuming that it is a map). Returns a map with those keys/values.</p></div></div></div><div class="public anchor" id="var-connect-fn"><h3>connect-fn</h3><div class="usage"><code>(connect-fn url {info-user "user", info-password "password", :as info})</code></div><div class="doc"><div class="markdown"><p>Returns a JDBC connection for given <code>url</code>.</p>
<p>Returns <code>nil</code> if <code>url</code> is not a <em>Buttle</em> URL (as of <code>accepts-url-fn</code>). Else opens a JDBC <code>Connection</code> to <code>:target-url</code> via <code>buttle.driver-manager/get-connection</code>. If that throws then this function throws. Otherwise the connection is returned. Note that in this case <em>Buttle</em> does not call/use the proxied JDBC driver directly (but relies on the <code>DriverManager</code>).</p>
<p>If <code>:datasource-spec</code> is given in the <em>Buttle</em> URL a datasource <code>ds</code> (as of <code>buttle-ds/retrieve-data-soure</code>) will be used instead of the <code>buttle.driver-manager/get-connection</code>.</p>
<p>Authentication credentials (user and password) are taken from <code>info</code> (keys <code>"user"</code> and <code>"password"</code>) if given. Else they are taken from <em>Buttle</em> URL (keys <code>:user</code> and <code>:password</code>). If the connection is opened via <code>DriverManager</code> then <code>info</code> will be passed onto <code>DriverManager/getConnection</code> so that any properties beyond <code>"user"</code> and <code>"password"</code> (which are set to the authentication credentials) contained in <code>info</code> are preserved. </p>
<p>If <code>:class-for-name</code> is set in the <em>Buttle</em> <code>url</code> then calls <code>(Class/forName class-for-name)</code> before opening the connection. This takes care of cases when the proxied driver is not loaded auto-magically by the <code>DriverManager</code>. This may happen when the <code>DriverManager</code> is initialized and the classloader does not <em>see</em> the proxied driver classes at that point (e.g. in JEE application servers when loading things via isolated classloaders).</p></div></div></div><div class="public anchor" id="var-eval-buttle-user-file.21"><h3>eval-buttle-user-file!</h3><div class="usage"><code>(eval-buttle-user-file!)</code></div><div class="doc"><div class="markdown"><p>If system property <code>buttle.user-file</code> is set, uses <code>load-file</code> to evaluate that file.</p>
<p>This function is called when namespace <code>buttle.driver</code> is loaded. This happens for example when die <em>Buttle</em> JDBC driver is loaded.</p>
<p>Use this function to load your own code when you do not control the main program flow (like when using <em>Buttle</em> in tools like SQuirreL or in a Java application server when you do not control/own the main application).</p></div></div></div><div class="public anchor" id="var-make-driver"><h3>make-driver</h3><div class="usage"><code>(make-driver)</code></div><div class="doc"><div class="markdown"><p>Creates and returns a <em>Buttle</em> <code>java.sql.Driver</code>.</p>
<p>Note that the underlying driver (which delegates to the real driver) is a Clojure <code>proxy</code> (not an instance of <code>buttle.jdbc.Driver</code>) which is wrapped by a <code>buttle.proxy/make-proxy</code>. So calls to retured driver can be intercepted by <code>buttle.proxy/def-handle</code>.</p>
<p>This driver can be registered with the <code>java.sql.DriverManager</code>. There are two important methods that this driver (proxy) implements: <code>connect</code> and <code>acceptsURL</code>. These are needed for interaction with the <code>DriverManager</code> so that the <em>Buttle</em> driver can be <em>picked up</em> for <em>Buttle</em> URLs.</p>
<p>Note: the <em>Buttle</em> proxy will set the current thread’s context classloader (TCCL) to <em>Buttle</em>’s classloader when delegating to <code>buttle.proxy/handle</code>. This is needed for cases when <em>Buttle</em> is used as a data-source and deployed as a <em>module</em> in Wildfly/JBoss application server. In this case <code>clojure.lang.RT</code> tries to load <code>clojure/core.clj</code> which it can’t because it uses the current thread’s context classloader and for Wildfly that will not be the <em>Buttle</em> module’s classloader. So we explicitly set the TCCL and things work. In non-application-server cases this usually does not hurt. At the moment you cannot configure this feature.</p></div></div></div><div class="public anchor" id="var-parse-jdbc-url"><h3>parse-jdbc-url</h3><div class="usage"><code>(parse-jdbc-url url)</code></div><div class="doc"><div class="markdown"><p>Parses a <em>Buttle</em> JDBC URL.</p>
<p>A <em>Buttle</em> JDBC URL has the format <code>#"jdbc:buttle:(.+)"</code>. Any text after <code>jdbc:buttle:</code> will be <code>read-string-eval</code>’ed and should yield a map with keys <code>:target-url</code>, <code>:user</code> and <code>:password</code>. The <code>eval</code>’ed value is returned (even if not a map). If <code>url</code> does not match the pattern <code>nil</code> is returned. If <code>read-string-eval</code> throws an <code>Exception</code> then an <code>Exception</code> will be thrown.</p></div></div></div></div></body></html>